# Amazon QuickSight 商业智能设置指南

本指南将引导您设置 Amazon QuickSight,在 Redshift 数据仓库之上构建交互式仪表板和报告。

## 目录

1. [先决条件](#先决条件)
2. [订阅 QuickSight](#订阅-quicksight)
3. [连接到 Redshift](#连接到-redshift)
4. [创建数据集](#创建数据集)
5. [构建您的第一个分析](#构建您的第一个分析)
6. [创建可视化](#创建可视化)
7. [发布仪表板](#发布仪表板)
8. [高级功能](#高级功能)

---

## 先决条件

开始之前,请确保您具有:

- ✅ Redshift 集群已部署并运行(来自主设置)
- ✅ QuickSight VPC 连接已创建(QuickSightStack 已部署)
- ✅ 数据已加载到 `analytics` 架构表中
- ✅ 具有适当权限的 AWS 账户

## 订阅 QuickSight

### 步骤 1: 注册 QuickSight

1. 导航到 [QuickSight 控制台](https://quicksight.aws.amazon.com/)
2. 点击**注册 QuickSight**
3. 选择**企业版**以获得:
   - 行级安全
   - 每小时 SPICE 刷新
   - Active Directory 集成

### 步骤 2: 配置账户

1. **身份验证方法**: 选择 IAM 或 Active Directory
2. **QuickSight 区域**: 选择 `ap-southeast-1`(与 Redshift 相同)
3. **账户名称**: 输入唯一名称(例如,`my-company-analytics`)
4. **通知电子邮件**: 输入管理员电子邮件地址

### 步骤 3: 授予权限

启用对 AWS 服务的访问:

- ✅ **Amazon Redshift**: 自动发现集群
- ✅ **Amazon S3**: 访问 S3 存储桶(如果需要导出)
- ✅ **Amazon Athena**: 查询数据湖(可选)

点击**完成**以完成设置。

---

## 连接到 Redshift

### 步骤 1: 创建数据源

1. 在 QuickSight 控制台中,点击**数据集** → **新建数据集**
2. 选择**Redshift 自动发现**
3. 选择您的集群: `redshift-cluster`

### 步骤 2: 配置连接

#### 连接设置

- **数据源名称**: `redshift-analytics`
- **数据库名称**: `dev`
- **连接类型**: **使用 VPC 连接**
- **VPC 连接**: 选择 `redshift-vpc-connection`(由 CDK 创建)

#### 身份验证

- **方法**: 使用 IAM 凭证
- **IAM 角色**: 从 CloudFormation 输出中选择 QuickSightRedshiftRole ARN

### 步骤 3: 测试连接

点击**验证连接**以确保 QuickSight 可以访问 Redshift。

---

## 创建数据集

### 数据集 1: 订单分析

1. 点击**新建数据集** → 选择 `redshift-analytics` 数据源
2. **架构**: `analytics`
3. **表**: `orders`
4. 点击**编辑/预览数据**

#### 与客户连接

1. 点击**添加数据** → 选择 `customers` 表
2. 连接类型: **左连接**
3. 连接子句: `orders.customer_id = customers.customer_id`

#### 导入到 SPICE

- ✅ 启用**导入到 SPICE**以获得更快的性能
- SPICE 提供亚秒级查询响应时间
- 自动压缩和优化数据

点击**保存并发布** → 名称: `orders_with_customers`

### 数据集 2: 产品销售

1. 从 `order_items` 表创建新数据集
2. 与 `products` 连接: `order_items.product_id = products.product_id`
3. 与 `orders` 连接: `order_items.order_id = orders.order_id`
4. 导入到 SPICE
5. 保存为: `product_sales`

### 配置刷新计划

对于 SPICE 数据集,设置自动刷新:

1. 转到**数据集** → 选择数据集 → **刷新**选项卡
2. 点击**创建计划**
3. **频率**: 每天凌晨 2:00
4. **时区**: 您的本地时区
5. 点击**创建**

---

## 构建您的第一个分析

### 步骤 1: 创建分析

1. 转到**数据集** → 选择 `orders_with_customers`
2. 点击**创建分析**
3. QuickSight 打开分析工作区

### 步骤 2: 了解界面

#### 左侧面板 - 字段

- 维度(蓝色): 分类数据(customer_segment、region、status)
- 度量(绿色): 数字数据(total_amount、order_id 计数)

#### 顶部栏 - 可视化类型

- AutoGraph(自动选择)
- 条形图、折线图、饼图
- 表格、数据透视表、KPI
- 地图、散点图、热图

#### 画布

- 拖放可视化
- 调整大小和排列
- 添加筛选器和参数

---

## 创建可视化

### 可视化 1: 按地区销售(条形图)

1. 点击**添加** → **添加可视化**
2. 选择**垂直条形图**
3. 字段井:
   - X 轴: 拖动 `region`
   - 值: 拖动 `total_amount` → 聚合: **求和**
4. 格式:
   - 标题: "按地区总销售额"
   - Y 轴标签: "收入($)"
   - 排序: 按值降序

### 可视化 2: 收入趋势(折线图)

1. 添加新可视化 → **折线图**
2. 字段井:
   - X 轴: 拖动 `order_date`
   - 值: `total_amount` → 聚合: **求和**
3. 格式:
   - 显示数据标签: 开启
   - 线条样式: 平滑

### 可视化 3: 客户细分绩效(饼图)

1. 添加新可视化 → **饼图**
2. 字段井:
   - 组/颜色: 拖动 `customer_segment`
   - 值: `total_amount` → 聚合: **求和**
3. 格式:
   - 显示百分比: 开启
   - 图例位置: 右侧

### 可视化 4: 前 10 个产品(表格)

1. 添加新可视化 → **表格**
2. 字段井:
   - 行: 拖动 `product_name`
   - 值:
     - `quantity` → 聚合: **求和** → 重命名: "已售单位"
     - `total_amount` → 聚合: **求和** → 重命名: "收入"
3. 筛选器:
   - 在 `product_name` 上添加筛选器
   - 筛选器类型: **前后**
   - 按收入排名前 10
4. 格式:
   - 条件格式: 收入列上的颜色刻度

### 可视化 5: KPI - 总收入

1. 添加新可视化 → **KPI**
2. 字段井:
   - 值: 拖动 `total_amount` → 聚合: **求和**
3. 格式:
   - 数字格式: 货币($)
   - 比较: 环比(如果有时间序列数据)

### 可视化 6: 订单状态分布(环形图)

1. 添加新可视化 → **环形图**
2. 字段井:
   - 组/颜色: 拖动 `status`
   - 值: `order_id` → 聚合: **非重复计数**
3. 格式:
   - 显示百分比: 开启

---

## 高级功能

### 计算字段

创建自定义指标和维度:

#### 示例 1: 利润率

1. 点击**添加** → **添加计算字段**
2. **名称**: `profit_margin`
3. **公式**: `(sum({total_amount}) - sum({unit_cost} * {quantity})) / sum({total_amount})`
4. 点击**保存**
5. 在可视化中用作度量

#### 示例 2: 订单规模类别

1. 添加计算字段: `order_size_category`
2. **公式**:
```
ifelse(
  {total_amount} < 500, 'Small',
  {total_amount} < 1500, 'Medium',
  'Large'
)
```
3. 用作细分的维度

#### 示例 3: 订单后天数

1. 添加计算字段: `days_since_order`
2. **公式**:
```
dateDiff(now(), {order_date}, 'DD')
```

### 筛选器和参数

#### 添加筛选器

1. 点击**筛选器**窗格 → **添加筛选器**
2. 选择字段(例如,`order_date`)
3. 配置:
   - 筛选器类型: **相对日期**
   - 时间范围: 最近 30 天
4. 应用于: 所有可视化或特定可视化

#### 创建参数

1. 点击**参数** → **创建参数**
2. **名称**: `min_order_amount`
3. **数据类型**: 十进制
4. **默认值**: 100
5. 在计算字段或筛选器中使用

### 交互功能

#### 下钻

1. 选择可视化
2. 点击**字段井** → 添加层次结构
3. 示例: 地区 → 国家 → 城市
4. 用户可以点击以下钻

#### 操作

1. 选择可视化 → **操作**菜单
2. 添加操作: **筛选同一工作表可视化**
3. 当用户点击条形图时,其他可视化会自动筛选

#### 工具提示

1. 选择可视化 → **格式化可视化**
2. **工具提示**部分
3. 添加要在悬停时显示的字段

---

## 发布仪表板

### 步骤 1: 准备分析

1. 检查所有可视化的准确性
2. 添加标题和描述
3. 排列布局以提高可读性
4. 测试筛选器和交互

### 步骤 2: 发布

1. 点击**共享** → **发布仪表板**
2. **仪表板名称**: "销售分析仪表板"
3. **描述**: "每日销售绩效和客户见解"
4. 点击**发布仪表板**

### 步骤 3: 与用户共享

#### 与个人共享

1. 点击**共享** → **共享仪表板**
2. 输入用户电子邮件地址
3. 设置权限:
   - **查看者**: 仅可查看
   - **共同所有者**: 可以编辑和重新共享
4. 点击**共享**

#### 与组共享

1. 在 QuickSight 管理面板中创建组
2. 与整个组共享仪表板
3. 在组级别管理权限

### 步骤 4: 嵌入(可选)

用于嵌入到 Web 应用程序中:

1. 点击**共享** → **嵌入**
2. 选择嵌入选项:
   - **匿名嵌入**: 公共访问
   - **私有嵌入**: 需要 AWS 凭证
3. 复制嵌入代码
4. 集成到您的应用程序中

---

## 最佳实践

### 性能优化

1. **使用 SPICE**: 将数据导入 SPICE 以获得亚秒级性能
2. **增量刷新**: 对于大型数据集,使用增量刷新
3. **在源处聚合**: 在 Redshift 视图中预聚合数据
4. **限制数据**: 使用筛选器减少数据集大小

### 仪表板设计

1. **保持简单**: 每个仪表板 5-7 个可视化
2. **讲述故事**: 按逻辑流程排列可视化
3. **使用一致的颜色**: 匹配公司品牌
4. **添加上下文**: 包括标题、描述和工具提示
5. **移动友好**: 在移动设备上测试

### 安全

1. **行级安全**: 按用户限制数据访问
2. **列级安全**: 隐藏敏感字段
3. **VPC 连接**: 在 VPC 内保持数据私密
4. **IAM 角色**: 使用最小权限访问

### 维护

1. **监控 SPICE 使用情况**: 跟踪容量和成本
2. **安排刷新**: 在非高峰时段
3. **版本控制**: 在重大更改之前保存分析版本
4. **用户反馈**: 定期收集和整合反馈

---

## 示例仪表板创意

### 执行仪表板

- 总收入 KPI
- 收入趋势(折线图)
- 按地区销售(地图)
- 热门产品(表格)
- 客户细分(饼图)

### 销售绩效仪表板

- 每日/每周/每月销售趋势
- 按产品类别销售
- 销售代表绩效
- 转化漏斗
- 同比比较

### 客户分析仪表板

- 客户生命周期价值
- 客户获取趋势
- 流失分析
- 客户细分
- 地理分布

### 产品分析仪表板

- 产品绩效比较
- 库存水平
- 按产品的利润率
- 产品类别趋势
- 交叉销售分析

---

## 故障排除

### 连接问题

**问题**: 无法连接到 Redshift

- ✅ 验证 VPC 连接处于活动状态
- ✅ 检查安全组规则是否允许 QuickSight
- ✅ 确认 IAM 角色具有正确的权限
- ✅ 从 QuickSight 控制台测试连接

### 性能问题

**问题**: 仪表板加载缓慢

- ✅ 将数据导入 SPICE 而不是直接查询
- ✅ 使用筛选器减少数据集大小
- ✅ 在 Redshift 中预聚合数据
- ✅ 限制每个仪表板的可视化数量

### 数据问题

**问题**: 数据未刷新

- ✅ 检查 SPICE 刷新计划
- ✅ 验证 Redshift 集群正在运行
- ✅ 查看刷新历史记录以查找错误
- ✅ 手动触发刷新以测试

---

## 成本优化

### 定价概述

#### 企业版

- 作者: 每月每用户 $18
- 读者: 每会话 $0.30(每月每用户最高 $5)

#### SPICE

- 每月每 GB $0.25
- 每位作者免费 10GB

#### 降低成本的技巧

1. 对仅查看用户使用读者账户
2. 优化 SPICE 数据集(删除未使用的字段)
3. 共享仪表板而不是创建副本
4. 定期监控 SPICE 使用情况
5. 对不频繁访问的数据使用直接查询

---

## 后续步骤

1. **探索 Amazon Q**: 使用自然语言查询数据
2. **设置警报**: 在指标超过阈值时获得通知
3. **创建像素完美的报告**: 安排和通过电子邮件发送格式化报告
4. **构建移动仪表板**: 优化移动查看
5. **与应用程序集成**: 在您的应用程序中嵌入仪表板

---

## 其他资源

- [QuickSight 用户指南](https://docs.aws.amazon.com/quicksight/latest/user/)
- [QuickSight API 参考](https://docs.aws.amazon.com/quicksight/latest/APIReference/)
- [QuickSight 社区](https://repost.aws/tags/TA4iiGCS8iRGCR8OHN_wjBxw/amazon-quick-sight)
- [示例仪表板库](https://aws.amazon.com/quicksight/gallery/)
- [QuickSight 培训](https://aws.amazon.com/quicksight/resources/)
